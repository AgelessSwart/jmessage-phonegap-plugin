
<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
            <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">
            <title>JMessage Phonegap Sample App</title>
            <link href="css/jquery.mobile-1.1.1.css" rel="stylesheet" type="text/css"/>
            <script type="text/javascript" src="js/jquery.js"></script>
            <script type="text/javascript" src="js/jquery.mobile-1.1.1.js"></script>
            <script type="text/javascript" src="cordova.js"></script>
            <script type="text/javascript"> 
            					  
			 function gotoConversationList(){
				window.location.href="conversation-list.html"
			 }   
			 
			 
			 
			var rowcounter = 0;

			var tbl;
			function insertMessage(dict){
			

  				var  contentType= dict.contentType;
  				if(contentType == "JMSGContentTypeText"){
	  				var  lastMessage =  dict.contentText;
	  			}
 				
 		   	 	tbl=document.getElementById('dynamic_conversation');
 				var row = tbl.insertRow();
		 		row.id=rowcounter;
	     	 	cell = row.insertCell();
			 	cell.align = 'center';
				rowcounter++;
				var htmlText="<h3>"+ lastMessage + "</h3>";
				console.log("@"+htmlText);
				
				cell.innerHTML=htmlText;
			 }   
			 
			 
			 
			 function getMessageHistory(){
			 	var url=window.location.href;	
			  　var username = sessionStorage.getItem("jmessage_conversation_username");

 			    console.log("getMessageHistory lastest 100 message with username:" + username);
			    //读取的是从0开始的100条聊天记录，可按实现需求传不同的值
				 window.plugins.jmessagePlugin.getSingleHistoryMessage(username,0,100,function(response){

                                        var ss = JSON.stringify(response);
                                        	console.log("getMessageHistory ok: " + ss);
 											
 											for(var o in response){
 												insertMessage(response[o]);
 											}
                                        } ,function(response){          
											alert("getMessageHistory failed");
                                       		console.log("getMessageHistory fail" + response);
                                        });	
			 } 
			 
			 function onSingleConversationMessageReceived(){
			    console.log("onSingleConversationMessageReceived and instert");
                var messageDict = window.plugins.jmessagePlugin.singleReceiveMessage;
                console.log(messageDict);
                insertMessage(messageDict);
			 }
			 function onLoad(){
			    console.log("onLoad");
			 	getMessageHistory();
			 	
			 	document.addEventListener("jmessage.singleReceiveMessage", onSingleConversationMessageReceived, false);

			 }
			 					            					   
        </script>
    </head>
    <body onload="onLoad()"> 
    
        <div data-role="page" id="page">
        
        <div data-role="header">
     	   <h1>会话</h1>
	    </div>
           <input type="button" onclick="gotoConversationList()" value="返回会话列表" />
            <div data-role="content">
				<form>
					<div>
						
                        <center><h5>--对方用户名--</h5></center>
                        
                        <div data-role="fieldcontain">	
                           <table>
                                <tr>
                                    <td>
                                        <input type="text"   id="messageContent">
                                    </td>
                                </tr>
                            </table>
                            <input type="button" onclick="sendMessage()" value="发送" />
                        </div>
                        <center><h5>--对话记录--</h5></center>
                    	<table border="0" id="dynamic_conversation">
                    		
						</table>
                        
					</div>
				</form>
			</div>
		</div>
    </body>

</html>


